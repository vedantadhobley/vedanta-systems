name: vedanta-systems-dev

services:
  frontend:
    container_name: vedanta-systems-dev
    build:
      context: .
      dockerfile: Dockerfile.dev
      args:
        VITE_GITHUB_TOKEN: ${VITE_GITHUB_TOKEN}
    # Dev uses 4100, prod uses 3100 (both on same machine)
    ports:
      - "4100:3000"
    environment:
      - VITE_API_BASE_URL=http://localhost:8080
      - VITE_ENVIRONMENT=development
      - VITE_GITHUB_TOKEN=${VITE_GITHUB_TOKEN}
      # Use localhost for browser access (frontend runs in browser, not in container)
      - VITE_FOOTY_API_URL=http://localhost:4101/api/found-footy
    restart: unless-stopped
    # Enable volumes for live development (Dev Containers)
    volumes:
      - .:/app
      - /app/node_modules
      - /var/run/docker.sock:/var/run/docker.sock
      - /home/vedanta/.ssh:/root/.ssh:ro
      - /home/vedanta/photos:/app/public/photos:ro  # Shared photos (read-only)
    command: npm run dev -- --host 0.0.0.0
    networks:
      - vedanta-systems-dev
      - luv-dev
    depends_on:
      - api

  # API server handles all project APIs (/api/found-footy/*, /api/legal-tender/*, etc.)
  api:
    container_name: vedanta-systems-dev-api
    image: node:18-alpine
    working_dir: /app
    ports:
      - "4101:3001"
    environment:
      - API_PORT=3001
      # MongoDB
      - MONGODB_URI=mongodb://${FOUND_FOOTY_MONGO_USER}:${FOUND_FOOTY_MONGO_PASS}@found-footy-dev-mongo:27017/found_footy?authSource=admin
      # MinIO
      - MINIO_ENDPOINT=found-footy-dev-minio
      - MINIO_PORT=9000
      - MINIO_ACCESS_KEY=${FOUND_FOOTY_S3_USER}
      - MINIO_SECRET_KEY=${FOUND_FOOTY_S3_PASS}
    volumes:
      - .:/app
    command: sh -c "npm install && npx tsx watch src/server/index.ts"
    restart: unless-stopped
    networks:
      - vedanta-systems-dev
      - luv-dev

  # btop system monitor - serves host metrics via SSE broadcast
  btop:
    container_name: vedanta-systems-dev-btop
    hostname: luv
    build:
      context: ./btop
      dockerfile: Dockerfile
    restart: unless-stopped
    
    # Required for FULL host system visibility
    pid: host                    # See host processes
    network_mode: host           # See host network traffic (required for accurate net stats)
    privileged: true             # Required for GPU access and full /proc visibility
    
    volumes:
      # Host system info - mounted at original paths so btop works unchanged
      - /proc:/proc:ro
      - /sys:/sys:ro
      - /:/hostfs:ro                    # Host root filesystem for disk stats
      - /run/media:/run/media:ro        # Mounted drives (if any)
      
      # GPU access for AMD ROCm
      - /dev/dri:/dev/dri
      - /dev/kfd:/dev/kfd
    
    environment:
      - WRAPPER_PORT=4102        # Port for SSE server (binds to host directly with network_mode: host)
      - BTOP_HOST=local          # "local" or "user@host" for SSH to remote
    
    # No ports needed - network_mode: host means it binds directly to host ports
    
    # Ensure GPU is accessible
    devices:
      - /dev/dri:/dev/dri
    
    # AMD GPU specific - use GIDs since groups don't exist in container
    group_add:
      - "44"   # video
      - "992"  # render
    
    # No networks - network_mode: host is incompatible with docker networks

networks:
  # Internal network for vedanta-systems DEV services
  vedanta-systems-dev:
    name: vedanta-systems-dev
    driver: bridge
  
  # Shared network - persistent, cross-project communication
  # Only join this if you need to talk to OTHER projects
  luv-dev:
    name: luv-dev
    external: true

# Example: Add your backend services here when ready
# backend-service-1:
#   build:
#     context: ../path-to-service-1
#     dockerfile: Dockerfile
#   ports:
#     - "8080:8080"
#   environment:
#     - ENV=development
#   restart: unless-stopped
