name: vedanta-systems-prod

services:
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - VITE_GITHUB_TOKEN=${VITE_GITHUB_TOKEN}
        - VITE_FOOTY_API_URL=https://vedanta.systems/api/found-footy
    container_name: vedanta-systems-prod
    ports:
      - "3100:3000"
    restart: unless-stopped
    volumes:
      - /home/vedanta/photos:/app/dist/photos:ro
      - /home/vedanta/.cloudflared:/root/.cloudflared:ro
    networks:
      - vedanta-systems-prod
      - luv-prod
    depends_on:
      - api

  # API serverndles all project APIs (/api/found-footy/*, /api/legal-tender/*, etc.)
  api:
    container_name: vedanta-systems-prod-api
    build:
      context: .
      dockerfile: Dockerfile.api
    # No ports exposed - only accessible via nginx proxy on internal network
    environment:
      - NODE_ENV=production
      - API_PORT=3001
      # MongoDB - connects to found-footy-prod-mongo on luv-prod network
      - MONGODB_URI=mongodb://${FOUND_FOOTY_MONGO_USER}:${FOUND_FOOTY_MONGO_PASS}@found-footy-prod-mongo:27017/found_footy?authSource=admin
      # MinIO - connects to found-footy-prod-minio on luv-prod network
      - MINIO_ENDPOINT=found-footy-prod-minio
      - MINIO_PORT=9000
      - MINIO_ACCESS_KEY=${FOUND_FOOTY_S3_USER}
      - MINIO_SECRET_KEY=${FOUND_FOOTY_S3_PASS}
      # btop runs with network_mode:host, so reach it via host gateway
      - BTOP_HOST=host-gateway
    extra_hosts:
      - "host-gateway:host-gateway"
    restart: unless-stopped
    networks:
      - vedanta-systems-prod
      - luv-prod

  # btop system monitor - SSE broadcast of terminal output
  btop:
    container_name: vedanta-systems-prod-btop
    hostname: luv
    build:
      context: ./btop
      dockerfile: Dockerfile
    restart: unless-stopped
    
    # Required for FULL host system visibility
    pid: host                    # See host processes
    network_mode: host           # See host network traffic (required for accurate net stats)
    privileged: true             # Required for GPU access and full /proc visibility
    
    volumes:
      # Host system info - mounted at original paths so btop works unchanged
      - /proc:/proc:ro
      - /sys:/sys:ro
      - /:/hostfs:ro                    # Host root filesystem for disk stats
      - /run/media:/run/media:ro        # Mounted drives (if any)
      
      # GPU access for AMD ROCm
      - /dev/dri:/dev/dri
      - /dev/kfd:/dev/kfd
    
    environment:
      - WRAPPER_PORT=3102        # Prod: 3102, Dev: 4102 (binds to host with network_mode: host)
      - BTOP_HOST=local          # "local" or "user@host" for SSH to remote
    
    # No ports needed - network_mode: host means it binds directly to host ports
    
    # Ensure GPU is accessible
    devices:
      - /dev/dri:/dev/dri
    
    # AMD GPU specific - use GIDs since groups don't exist in container
    group_add:
      - "44"   # video
      - "992"  # render
    
    # Note: No networks needed with network_mode: host

networks:
  vedanta-systems-prod:
    name: vedanta-systems-prod
    driver: bridge
  luv-prod:
    name: luv-prod
    external: true
