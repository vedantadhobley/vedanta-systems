name: vedanta-systems-prod

services:
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - VITE_GITHUB_TOKEN=${VITE_GITHUB_TOKEN}
        - VITE_FOOTY_API_URL=https://vedanta.systems/api/found-footy
    container_name: vedanta-systems-prod
    ports:
      - "3100:3000"
    restart: unless-stopped
    volumes:
      - /home/vedanta/photos:/app/dist/photos:ro
      - /home/vedanta/.cloudflared:/root/.cloudflared:ro
    networks:
      - vedanta-systems-prod
      - luv-prod
    depends_on:
      - api

  # API serverndles all project APIs (/api/found-footy/*, /api/legal-tender/*, etc.)
  api:
    container_name: vedanta-systems-prod-api
    build:
      context: .
      dockerfile: Dockerfile.api
    # No ports exposed - only accessible via nginx proxy on internal network
    environment:
      - NODE_ENV=production
      - API_PORT=3001
      # MongoDB - connects to found-footy-prod-mongo on luv-prod network
      - MONGODB_URI=mongodb://${FOUND_FOOTY_MONGO_USER}:${FOUND_FOOTY_MONGO_PASS}@found-footy-prod-mongo:27017/found_footy?authSource=admin
      # MinIO - connects to found-footy-prod-minio on luv-prod network
      - MINIO_ENDPOINT=found-footy-prod-minio
      - MINIO_PORT=9000
      - MINIO_ACCESS_KEY=${FOUND_FOOTY_S3_USER}
      - MINIO_SECRET_KEY=${FOUND_FOOTY_S3_PASS}
    restart: unless-stopped
    networks:
      - vedanta-systems-prod
      - luv-prod

  # btop system monitor - serves host metrics via ttyd web terminal
  btop:
    container_name: vedanta-systems-prod-btop
    build:
      context: ./btop
      dockerfile: Dockerfile
    restart: unless-stopped
    
    # Required for host system visibility
    pid: host                    # See host processes
    privileged: true             # Required for GPU access and full /proc visibility
    
    volumes:
      # Host system info - mounted at original paths so btop works unchanged
      - /proc:/proc:ro
      - /sys:/sys:ro
      
      # GPU access for AMD ROCm
      - /dev/dri:/dev/dri
      - /dev/kfd:/dev/kfd
    
    environment:
      - TTYD_PORT=7681
      - BTOP_READONLY=true       # Read-only for public display
    
    # Ensure GPU is accessible
    devices:
      - /dev/dri:/dev/dri
    
    # AMD GPU specific - use GIDs since groups don't exist in container
    group_add:
      - "44"   # video
      - "992"  # render
    
    networks:
      - vedanta-systems-prod

networks:
  vedanta-systems-prod:
    name: vedanta-systems-prod
    driver: bridge
  luv-prod:
    name: luv-prod
    external: true
