<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>btop</title>
    <style>
        @font-face {
            font-family: 'JetBrainsMono NF';
            src: url('/fonts/JetBrainsMonoNerdFontMono-Regular.ttf') format('truetype'),
                 local('JetBrainsMono Nerd Font Mono'),
                 local('JetBrainsMono NF');
            font-weight: normal;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            background: #000; 
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        #terminal {
            display: grid;
            grid-template-columns: repeat(132, 6px);
            grid-template-rows: repeat(43, 12px);
            font-family: 'JetBrainsMono NF', monospace;
            font-size: 10px;
            line-height: 1;
            background: #000;
            transform-origin: center center;
        }
        #terminal span {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 6px;
            height: 12px;
            overflow: hidden;
        }
        #stats {
            position: fixed;
            bottom: 5px;
            right: 5px;
            color: #666;
            font-family: monospace;
            font-size: 10px;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="terminal"></div>
    </div>
    <div id="stats"></div>
    
    <script>
        const COLS = 132;
        const ROWS = 43;
        const TOTAL_CELLS = COLS * ROWS;
        const container = document.getElementById('container');
        const terminal = document.getElementById('terminal');
        const stats = document.getElementById('stats');
        
        // Cell state array - persists between frames
        let cells = new Array(TOTAL_CELLS);
        for (let i = 0; i < TOTAL_CELLS; i++) {
            cells[i] = [' ', null, null, 0];  // [char, fg, bg, bold]
        }
        
        // DOM span elements - created once
        let spans = [];
        
        // Stats tracking
        let frameCount = 0;
        let deltaCount = 0;
        let lastBytes = 0;
        let totalBytes = 0;
        
        function initGrid() {
            const fragment = document.createDocumentFragment();
            for (let i = 0; i < TOTAL_CELLS; i++) {
                const span = document.createElement('span');
                span.textContent = '\u00A0';  // nbsp
                fragment.appendChild(span);
                spans.push(span);
            }
            terminal.appendChild(fragment);
        }
        
        function updateCell(index, char, fg, bg, bold) {
            const span = spans[index];
            if (!span) return;
            
            span.textContent = char === ' ' ? '\u00A0' : char;
            span.style.color = fg ? '#' + fg : '';
            span.style.background = bg ? '#' + bg : '';
            span.style.fontWeight = bold ? 'bold' : '';
        }
        
        function handleMessage(data) {
            frameCount++;
            lastBytes = JSON.stringify(data).length;
            totalBytes += lastBytes;
            
            if (data.t === 'f') {
                // Full frame - replace all cells
                cells = data.c;
                for (let i = 0; i < TOTAL_CELLS; i++) {
                    const [char, fg, bg, bold] = cells[i];
                    updateCell(i, char, fg, bg, bold);
                }
            } else if (data.t === 'd') {
                // Delta - update only changed cells
                deltaCount++;
                for (const change of data.d) {
                    const [index, char, fg, bg, bold] = change;
                    cells[index] = [char, fg, bg, bold];
                    updateCell(index, char, fg, bg, bold);
                }
            }
            
            // Update stats display
            const pct = deltaCount > 0 ? Math.round((deltaCount / frameCount) * 100) : 0;
            const avgBytes = Math.round(totalBytes / frameCount);
            stats.textContent = `${data.t === 'f' ? 'FULL' : 'Î”' + data.d.length} | ${lastBytes}B | avg:${avgBytes}B | ${pct}% deltas`;
        }
        
        function resize() {
            const cellW = 6;
            const cellH = 12;
            const termW = COLS * cellW;
            const termH = ROWS * cellH;
            
            terminal.style.width = termW + 'px';
            terminal.style.height = termH + 'px';
            terminal.style.fontSize = (cellH * 0.85) + 'px';
            
            const scaleX = container.clientWidth / termW;
            const scaleY = container.clientHeight / termH;
            const scale = Math.min(scaleX, scaleY);
            
            terminal.style.transform = `scale(${scale})`;
            
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: 'btop-dimensions',
                    aspectRatio: 1.534
                }, '*');
            }
        }
        
        function getStreamUrl() {
            const path = window.location.pathname;
            if (path.includes('/api/btop')) return '/api/btop/stream';
            return '/stream';
        }
        
        // Initialize
        initGrid();
        resize();
        window.addEventListener('resize', resize);
        
        // Connect to SSE
        const eventSource = new EventSource(getStreamUrl());
        
        eventSource.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                handleMessage(data);
            } catch (e) {
                console.error('Parse error:', e);
            }
        };
        
        eventSource.onerror = () => {
            stats.textContent = 'Connection lost...';
            terminal.style.opacity = '0.5';
        };
    </script>
</body>
</html>
