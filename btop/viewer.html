<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>btop</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            background: #000; 
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        #terminal-wrapper {
            transform-origin: center center;
        }
        #terminal {
            pointer-events: none;
        }
        .xterm-viewport::-webkit-scrollbar { display: none; }
        .xterm-viewport { scrollbar-width: none; overflow: hidden !important; }
        /* Hide all cursor elements */
        .xterm-cursor-layer,
        .xterm-cursor,
        .xterm-cursor-block,
        .xterm-cursor-outline,
        .xterm-cursor-bar,
        .xterm-cursor-underline { 
            display: none !important; 
            visibility: hidden !important;
            opacity: 0 !important;
        }
        /* Disable text selection */
        .xterm-screen {
            user-select: none !important;
            -webkit-user-select: none !important;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="terminal-wrapper">
            <div id="terminal"></div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script>
        const COLS = 132;
        const ROWS = 43;
        
        const term = new Terminal({
            cols: COLS,
            rows: ROWS,
            cursorBlink: false,
            cursorStyle: 'bar',
            cursorInactiveStyle: 'none',
            cursorWidth: 0,
            disableStdin: true,
            convertEol: true,
            scrollback: 0,
            fontFamily: 'monospace',
            fontSize: 14,
            theme: {
                background: '#000000',
                foreground: '#c9a0f0',
                cursor: 'transparent',
                cursorAccent: 'transparent'
            }
        });
        
        const container = document.getElementById('container');
        const wrapper = document.getElementById('terminal-wrapper');
        
        term.open(document.getElementById('terminal'));
        term.write('\x1b[?25l');
        
        function resize() {
            // xterm.js cell dimensions at fontSize 14
            const cellWidth = 8.4;
            const cellHeight = 17;
            const termWidth = COLS * cellWidth;
            const termHeight = ROWS * cellHeight;
            
            const scaleX = container.clientWidth / termWidth;
            const scaleY = container.clientHeight / termHeight;
            const scale = Math.min(scaleX, scaleY) * 0.98;
            
            wrapper.style.transform = `scale(${scale})`;
            
            // Report to parent for aspect ratio
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: 'btop-dimensions',
                    width: termWidth * scale,
                    height: termHeight * scale,
                    aspectRatio: termWidth / termHeight
                }, '*');
            }
        }
        
        // Detect if loaded through API proxy
        function getStreamUrl() {
            const path = window.location.pathname;
            if (path.includes('/api/btop')) {
                return '/api/btop/stream';
            }
            return '/stream';
        }
        
        const eventSource = new EventSource(getStreamUrl());
        
        eventSource.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                const content = data.frame.replace(/\n$/, '');
                term.write('\x1b[?25l\x1b[H\x1b[J' + content + '\x1b[?25l');
            } catch (e) {
                console.error('Parse error:', e);
            }
        };
        
        eventSource.onerror = () => {
            term.write('\x1b[H\x1b[31mConnection lost...\x1b[0m');
        };
        
        window.addEventListener('resize', resize);
        resize();
    </script>
</body>
</html>
