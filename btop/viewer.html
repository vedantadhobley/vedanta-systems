<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>btop</title>
    <style>
        @font-face {
            font-family: 'JetBrainsMono NF';
            src: url('/fonts/JetBrainsMonoNerdFont-Regular.woff2') format('woff2'),
                 local('JetBrainsMono Nerd Font'),
                 local('JetBrainsMono NF');
            font-weight: normal;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            background: #000; 
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        #terminal {
            display: grid;
            grid-template-columns: repeat(132, 6px);
            grid-template-rows: repeat(43, 12px);
            font-family: 'JetBrainsMono NF', monospace;
            font-size: 10px;
            line-height: 1;
            background: #000;
            transform-origin: center center;
        }
        #terminal span {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 6px;
            height: 12px;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="terminal"></div>
    </div>
    
    <script>
        const COLS = 132;
        const ROWS = 43;
        const container = document.getElementById('container');
        const terminal = document.getElementById('terminal');
        
        // ANSI color palette (256 colors)
        const COLORS_16 = [
            '#000000', '#aa0000', '#00aa00', '#aa5500',
            '#0000aa', '#aa00aa', '#00aaaa', '#aaaaaa',
            '#555555', '#ff5555', '#55ff55', '#ffff55',
            '#5555ff', '#ff55ff', '#55ffff', '#ffffff'
        ];
        
        function get256Color(n) {
            if (n < 16) return COLORS_16[n];
            if (n < 232) {
                n -= 16;
                const r = Math.floor(n / 36) * 51;
                const g = Math.floor((n % 36) / 6) * 51;
                const b = (n % 6) * 51;
                return `rgb(${r},${g},${b})`;
            }
            const gray = (n - 232) * 10 + 8;
            return `rgb(${gray},${gray},${gray})`;
        }
        
        function parseAnsiToGrid(ansi) {
            const cells = [];
            const lines = ansi.split('\n').slice(0, ROWS);
            
            let fg = null, bg = null, bold = false;
            const ansiPattern = /\x1b\[([0-9;]*)m/g;
            
            for (let row = 0; row < ROWS; row++) {
                const line = lines[row] || '';
                let col = 0;
                let pos = 0;
                
                while (col < COLS && pos < line.length) {
                    // Check for ANSI escape
                    ansiPattern.lastIndex = pos;
                    const match = ansiPattern.exec(line);
                    
                    if (match && match.index === pos) {
                        // Parse ANSI codes
                        const codes = match[1] ? match[1].split(';').map(Number) : [0];
                        let i = 0;
                        while (i < codes.length) {
                            const c = codes[i];
                            if (c === 0) { fg = null; bg = null; bold = false; }
                            else if (c === 1) bold = true;
                            else if (c === 22) bold = false;
                            else if (c === 38 && codes[i+1] === 5) { fg = get256Color(codes[i+2]); i += 2; }
                            else if (c === 38 && codes[i+1] === 2) { fg = `rgb(${codes[i+2]},${codes[i+3]},${codes[i+4]})`; i += 4; }
                            else if (c === 48 && codes[i+1] === 5) { bg = get256Color(codes[i+2]); i += 2; }
                            else if (c === 48 && codes[i+1] === 2) { bg = `rgb(${codes[i+2]},${codes[i+3]},${codes[i+4]})`; i += 4; }
                            else if (c === 39) fg = null;
                            else if (c === 49) bg = null;
                            else if (c >= 30 && c <= 37) fg = COLORS_16[c - 30];
                            else if (c >= 40 && c <= 47) bg = COLORS_16[c - 40];
                            else if (c >= 90 && c <= 97) fg = COLORS_16[c - 90 + 8];
                            else if (c >= 100 && c <= 107) bg = COLORS_16[c - 100 + 8];
                            i++;
                        }
                        pos = match.index + match[0].length;
                    } else {
                        // Regular character
                        const char = line[pos] || ' ';
                        cells.push({ char, fg, bg, bold });
                        col++;
                        pos++;
                    }
                }
                
                // Pad remaining columns
                while (col < COLS) {
                    cells.push({ char: ' ', fg: null, bg: null, bold: false });
                    col++;
                }
            }
            
            // Pad remaining rows
            while (cells.length < COLS * ROWS) {
                cells.push({ char: ' ', fg: null, bg: null, bold: false });
            }
            
            return cells;
        }
        
        function renderGrid(cells) {
            const fragment = document.createDocumentFragment();
            for (const cell of cells) {
                const span = document.createElement('span');
                span.textContent = cell.char === ' ' ? '\u00A0' : cell.char;
                if (cell.fg) span.style.color = cell.fg;
                if (cell.bg) span.style.background = cell.bg;
                if (cell.bold) span.style.fontWeight = 'bold';
                fragment.appendChild(span);
            }
            terminal.innerHTML = '';
            terminal.appendChild(fragment);
        }
        
        function resize() {
            // Fixed cell dimensions - characters centered in each cell
            const cellW = 6;
            const cellH = 12;
            const termW = COLS * cellW;
            const termH = ROWS * cellH;
            
            terminal.style.width = termW + 'px';
            terminal.style.height = termH + 'px';
            terminal.style.fontSize = (cellH * 0.85) + 'px';
            
            const scaleX = container.clientWidth / termW;
            const scaleY = container.clientHeight / termH;
            const scale = Math.min(scaleX, scaleY);
            
            terminal.style.transform = `scale(${scale})`;
            
            // Always send the fixed aspect ratio
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: 'btop-dimensions',
                    aspectRatio: 1.534  // 132*6 / 43*12 = 792/516
                }, '*');
            }
        }
        
        function getStreamUrl() {
            const path = window.location.pathname;
            if (path.includes('/api/btop')) return '/api/btop/stream';
            return '/stream';
        }
        
        const eventSource = new EventSource(getStreamUrl());
        
        eventSource.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                const cells = parseAnsiToGrid(data.frame);
                renderGrid(cells);
            } catch (e) {
                console.error('Parse error:', e);
            }
        };
        
        eventSource.onerror = () => {
            terminal.innerHTML = '<span style="color:#ff5555;grid-column:span 132">Connection lost...</span>';
        };
        
        window.addEventListener('resize', resize);
        resize();
    </script>
</body>
</html>
